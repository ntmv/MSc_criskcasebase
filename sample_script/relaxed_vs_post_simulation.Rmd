---
title: "Relaxed Lasso Glmnet Simulation"
author: "Alexander Romanus"
date: "`r Sys.Date()`"
output:
  html_document: 
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
library(casebase)
library(future.apply)
library(glmnet)
#library(mtool)
library(parallelly)
library(timereg)
library(parallel)
library(tictoc)
library(tidyverse)
#library(riskRegression)
library(cmprsk)
library(survsim)
library(caret)
library(Matrix)

# Helper functions 
source("src/helper_functions.R")
```

# Simulation setup

```{r setting-up-simulation}
set.seed(2023)
p <- 20
n <- 100

beta = c()
for (i in seq(1:(p+1))) {
  if (i == 1) {
    beta = c(beta, 1)
  }
  else if (i %% 2 == 0) {
    beta = c(beta, 0)
  } else {
    beta = c(beta, 0.5)
  }
}
beta = as.matrix(beta)
beta_neg = -beta


zero_ind1 <- which(beta == 0)
nonzero_ind1 <- which(beta != 0)


# Generate X (iid case)
X <- matrix(rnorm(n*p), nrow = n, ncol = p)
X = cbind(rep(1, times = 100), X)


#Generate Y
epsilon <- rnorm(n, sd = 0.5)
#Y1 = as.list(as.data.frame.matrix(X %*% beta + epsilon))$V1
Y1 = X %*% beta + epsilon
Y2 = X %*% beta_neg + epsilon


```

``` {r train-test-split, echo=FALSE, include = FALSE}
set.seed(2023)

train_index_Y1 = caret::createDataPartition(Y1, p = 0.80, list = FALSE)
train_index_Y2 = caret::createDataPartition(Y1, p = 0.80, list = FALSE)


x_train = X[train_index_Y1, -1]
y1_train = Y1[train_index_Y1]

x_test = X[-train_index_Y1, -1]
y1_test = Y1[-train_index_Y1]

y2_train = Y2[train_index_Y2]

y2_test = Y2[-train_index_Y2]
```

# Fits

``` {r different-models-fits, echo=FALSE, include = FALSE}
set.seed(2023)
fit_Y1 = cv.glmnet(x_train, y1_train, gamma = 0, relax = FALSE)
relaxed_fit_Y1 = cv.glmnet(x_train, y1_train, gamma = 0, relax = TRUE)
my_relaxed_fit_Y1 = myRelaxed(x_train, y1_train, FALSE)
my_relaxed_fit_cv_Y1 = myRelaxed(x_train, y1_train, TRUE)
```

``` {r post-lasso-fits, echo=FALSE, include = FALSE}
set.seed(2023)
coef_lasso_same_lambda = as.data.frame.matrix(coef(fit_Y1))[-1, ]
non_zero_coef_lasso_then_OLS_same_lambda = coef_lasso_same_lambda[coef_lasso_same_lambda != 0]
non_zero_coef_lasso_then_OLS_same_lambda_indeces = which(coef_lasso_same_lambda %in% non_zero_coef_lasso_then_OLS_same_lambda)

lambda_min = fit_Y1$lambda.min
lambda_1se = fit_Y1$lambda.1se

coefficient_names = colnames(as.data.frame(x_train))
selected_coefficient_names = coefficient_names[non_zero_coef_lasso_then_OLS_same_lambda_indeces]
new_x_train = x_train[, non_zero_coef_lasso_then_OLS_same_lambda_indeces]
colnames(new_x_train) = c(selected_coefficient_names)

fit_Y1_post_lasso_lambda_min = glmnet(new_x_train, y1_train, lambda = lambda_min)
fit_Y1_post_lasso_lambda_1se = glmnet(new_x_train, y1_train, lambda = lambda_1se)
```

# Results

### Coefficients

``` {r resulting-coefficients, echo=FALSE}
coefficient_names = colnames(as.data.frame(x_train))
coefficient_names = c("Model fitting procedure", coefficient_names)
coefficient_values = data.frame(matrix(nrow = 0, ncol = length(coefficient_names) + 1))

col_names = rownames(as.data.frame.matrix(coef(relaxed_fit_Y1)))
myRelaxed_coefficient_row = formatCoefficientTableRow(my_relaxed_fit_Y1$coefficients, col_names)

coef_values = as.numeric(coef(fit_Y1_post_lasso_lambda_min))
coef_names = rownames(coef(fit_Y1_post_lasso_lambda_min))
names(coef_values) = coef_names
Y1_post_lasso_lambda_min_coefficient_row = formatCoefficientTableRow(coef_values, col_names)

coef_values = as.numeric(coef(fit_Y1_post_lasso_lambda_1se))
coef_names = rownames(coef(fit_Y1_post_lasso_lambda_1se))
names(coef_values) = coef_names
Y1_post_lasso_lambda_1se_coefficient_row = formatCoefficientTableRow(coef_values, col_names)



coefficient_values = rbind(coefficient_values, 
                           c(0, lapply(fit_Y1$glmnet.fit$beta[, fit_Y1$index[1]], function(x) round(x, 3))),
                           c(0, lapply(coef(fit_Y1)[-1], function(x) round(x, 3))),
                           c(0, lapply(relaxed_fit_Y1$glmnet.fit$relaxed$beta[, relaxed_fit_Y1$relaxed$index[1]], function(x) round(x, 3))),
                           c(0, lapply(coef(relaxed_fit_Y1)[-1], function(x) round(x, 3))),
                           c(0, lapply(myRelaxed_coefficient_row, function(x) round(x, 3))),
                           c(0, lapply(Y1_post_lasso_lambda_min_coefficient_row, function(x) round(x, 3))),
                           c(0, lapply(Y1_post_lasso_lambda_1se_coefficient_row, function(x) round(x, 3))))
                        
colnames(coefficient_values) = coefficient_names
model_fit_labels = c("cv.glmnet relax = FALSE, LASSO, lambda min", "cv.glmnet relax = FALSE, LASSO, lambda 1se", "cv.glmnet relax = TRUE, lambda min", "cv.glmnet relax = TRUE, lambda 1se", "Relaxed LASSO implementation", "Post LASSO lambda min", "Post LASSO lambda 1se")


options(digits = 5)

coefficient_values[, 1] = model_fit_labels
coefficient_values
```

### MSEs

``` {r resulting-MSEs, echo=FALSE}
pred_fit_min = predict(fit_Y1, newx = x_test, s = fit_Y1$lambda.min)
pred_fit_1se = predict(fit_Y1, newx = x_test, s = fit_Y1$lambda.1se)
pred_fit_relaxed_min = predict(relaxed_fit_Y1, newx = x_test, s = relaxed_fit_Y1$relaxed$lambda.min)
pred_fit_relaxed_1se = predict(relaxed_fit_Y1, newx = x_test, s = relaxed_fit_Y1$relaxed$lambda.1se)

pred_myRelaxed = predict(my_relaxed_fit_Y1, newx = x_test)

coefficient_names = colnames(as.data.frame(x_test))
new_x_test = x_test[, non_zero_coef_lasso_then_OLS_same_lambda_indeces]
colnames(new_x_test) = rownames(as.data.frame.matrix(fit_Y1_post_lasso_lambda_min$beta))
pred_fit_post_lasso_min = predict(fit_Y1_post_lasso_lambda_min, newx = new_x_test, s = fit_Y1$lambda.min)


coefficient_names = colnames(as.data.frame(x_test))
new_x_test = x_test[, non_zero_coef_lasso_then_OLS_same_lambda_indeces]
colnames(new_x_test) = rownames(as.data.frame.matrix(fit_Y1_post_lasso_lambda_1se$beta))
pred_fit_post_lasso_1se = predict(fit_Y1_post_lasso_lambda_1se, newx = new_x_test, s = fit_Y1$lambda.1se)


# Compute MSE
mse_min <- sum((pred_fit_min - y1_test)^2)
mse_1se <- sum((pred_fit_1se - y1_test)^2)
mse_relaxed_min <- sum((pred_fit_relaxed_min - y1_test)^2)
mse_relaxed_1se <- sum((pred_fit_relaxed_1se - y1_test)^2)
mse_myRelaxed <- sum((pred_myRelaxed - y1_test)^2)
mse_post_lasso_min <- sum((pred_fit_post_lasso_min - y1_test)^2)
mse_post_lasso_1se <- sum((pred_fit_post_lasso_1se - y1_test)^2)

MSEs = data.frame(matrix(nrow = 7, ncol = 2))
colnames(MSEs) = c("Model fitting procedure", "Test MSE")
MSEs[, 1] = model_fit_labels
MSEs[, 2] = c(mse_min, mse_1se, mse_relaxed_min, mse_relaxed_1se, mse_relaxed_1se, mse_post_lasso_min, mse_post_lasso_1se)

MSEs

```

# CV MSE plot by log lambda

``` {r relaxed-lasso-glmnet-cv-results, echo=FALSE}
par(mfrow = c(1, 1), mar = c(2, 4, 6, 4))
plot(fit_Y1, main = "relax = FALSE, LASSO")
plot(relaxed_fit_Y1, main = "relax = TRUE")
```

